# JVM 的类加载阶段

JVM 的类加载分为五个阶段：
1. 加载：被虚拟机读入内存
2. 验证：验证 Class 字节流的数据是否遵守JVM的规定
3. 准备：正式为类变量（静态变量）分配内存并设置初始值，并非代码中设置的值
4. 解析：将常量池中的符号引用解析为直接引用
5. 初始化：真正执行类中定义的java代码

# 加载

指 JVM 读取 class 文件，并且根据 Class 文件描述创建 java.lang.Class 对象的过程。
类加载过程主要包含将 Class 文件读取到运行时区域的方法区内，在堆中创建 java.lang.Class 对象，并封装类在方法区的数据结构的过程。
在读取 Class 文件是既可以通过文件的形式读取，也可以通过 jar 包、war 包读取，还可以通过代理自动生成 Class或其他方式读取

# 验证

主要用于确保 Class 文件符合当前虚拟机的要求，保障虚拟机自身的安全，只有通过验证的 CLass 文件才能被 JVM 加载

# 准备

主要工作是在方法区中为类变量分配内存空间并设置类中变量的初始值。
初始值指不同数据类型的默认值，这里需要注意 final 类型的变量和非final类型的变量在准备阶段的数据初始化过程不同

例如一个成员变量定义如下：
public static long value = 1000;
在以上代码中，静态变量 value 在准备阶段的初始值是0，将 value 设置为 1000 的动作是在对象初始化时完成的，因为 JVM 在编译阶段会将静态变量的初始化操作定义在构造器中。
public static final int value = 1000;
则JVM在编译阶段后会为final类型的变量value生成其对应的ConstantValue属性，虚拟机在准备阶段会根据ConstantValue属性将value赋值为1000。

总结：静态变量会赋两次初值，准备阶段赋零值，初始化时赋用户设定值，而final变量会在准备阶段一次性赋值完毕

# 解析

JVM 会将常量池中的符号引用替换为直接引用。

# 初始化

主要通过执行类构造器的 <client> 方法为类进行初始化。
<client> 方法是在编译阶段由编译器自动收集类中静态语句和变量的赋值操作组成的。JVM规定，只有在父类的 <client> 方法都执行成功后，子类中的 <client> 方法才可以被执行。
在一个类中既没有静态变量赋值操作也没有静态语句块时，编译器不会为该类生成 <client> 方法。

在发生以下几种情况时，JVM不会执行类的初始化流程：
1. 常量在编译时会将其常量值存入使用该常量的类的常量池中，该过程不需要调用常量所在的类，因此，不会触发该常量类的初始化。
2. 在子类引用父类的静态字段时，不会触发子类的初始化，只会触发父类的初始化。
3. 定义对象数组，不会触发父类的初始化
4. 在使用类名获取 Class 对象时不会触发类的初始化
5. 在使用 Class.forName 加载指定的类时，可以通过 initialize 参数设置是否需要对类进行初始化
6. 在使用ClassLoader默认的loadClass方法加载类时不会触发该类的初始化。